<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Eval Results Viewer</title>
    <style>
      :root {
        --space-1: 4px;
        --space-2: 8px;
        --space-3: 12px;
        --space-4: 16px;
        --space-5: 24px;
        /* Light theme (default) */
        --bg: #ffffff;
        --text: #111827;
        --card-bg: #ffffff;
        --border: #e5e7eb;
        --th-bg: #f9fafb;
        --zebra: #fafafa;
        --muted: #6b7280;
        --ok-fg: #065f46;
        --ok-bg: #ecfdf5;
        --fail-fg: #991b1b;
        --fail-bg: #fef2f2;
        color-scheme: light dark;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #0b0f19;
          --text: #e5e7eb;
          --card-bg: #111827;
          --border: #1f2937;
          --th-bg: #111827;
          --zebra: #0f172a;
          --muted: #9ca3af;
          --ok-fg: #34d399;
          --ok-bg: #064e3b;
          --fail-fg: #fca5a5;
          --fail-bg: #450a0a;
        }
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          Cantarell, Noto Sans, Helvetica, Arial, Apple Color Emoji,
          Segoe UI Emoji, Segoe UI Symbol;
        margin: var(--space-5);
        background: var(--bg);
        color: var(--text);
      }
      header {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        flex-wrap: wrap;
      }
      h1 {
        font-size: 20px;
        margin: 0;
      }
      .controls {
        display: flex;
        gap: var(--space-2);
        align-items: center;
        flex-wrap: wrap;
      }
      select,
      input[type="text"],
      button {
        padding: var(--space-2) var(--space-3);
        font-size: 14px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: var(--space-4);
      }
      th,
      td {
        border: 1px solid var(--border);
        padding: var(--space-2);
        text-align: left;
      }
      th {
        background: var(--th-bg);
        position: sticky;
        top: 0;
      }
      th.sortable {
        cursor: pointer;
        user-select: none;
      }
      th.sorted-asc::after {
        content: " \25B2"; /* ▲ */
      }
      th.sorted-desc::after {
        content: " \25BC"; /* ▼ */
      }
      tbody tr:nth-child(odd) {
        background: var(--zebra);
      }
      .ok {
        color: var(--ok-fg);
        background: var(--ok-bg);
        padding: var(--space-1) var(--space-2);
        border-radius: 4px;
        display: inline-block;
      }
      .fail {
        color: var(--fail-fg);
        background: var(--fail-bg);
        padding: var(--space-1) var(--space-2);
        border-radius: 4px;
        display: inline-block;
      }
      details {
        margin-top: var(--space-4);
      }
      .small {
        color: #6b7280;
        font-size: 12px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: var(--space-2);
      }
      /* Uniform vertical spacing between sections */
      section {
        margin-top: var(--space-4);
      }
      .card {
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: var(--space-3);
        background: var(--card-bg);
      }
      .muted {
        color: var(--muted);
      }
      .hidden {
        display: none;
      }
      @media (max-width: 800px) {
        .grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Eval Results Viewer</h1>
      <div class="controls">
        <label
          >Workflow
          <select id="workflow"></select>
        </label>
        <label
          >Variant
          <select id="variant"></select>
        </label>
        <label
          >Filter Model
          <input
            id="modelFilter"
            type="text"
            placeholder="e.g., google/gemini"
          />
        </label>
        <label
          >Search Reason/Text
          <input id="search" type="text" placeholder="contains..." />
        </label>
        <button id="reload">Reload from Server</button>
      </div>
    </header>

    <section class="grid" id="summary"></section>

    <section class="grid" id="model-averages">
      <div class="card" style="grid-column: span 4">
        <div class="muted small">Averages per model</div>
        <table>
          <thead id="modelHead">
            <tr>
              <th class="sortable" data-sort-key="model">Model</th>
              <th class="sortable" data-sort-key="total">Runs</th>
              <th class="sortable" data-sort-key="pass">Pass</th>
              <th class="sortable" data-sort-key="passRate">Pass Rate</th>
              <th class="sortable" data-sort-key="avgSeconds">
                Avg Elapsed (s)
              </th>
              <th class="sortable" data-sort-key="avgTotalTokens">
                Avg Tokens (in/out/total)
              </th>
            </tr>
          </thead>
          <tbody id="modelRows"></tbody>
        </table>
      </div>
    </section>

    <table>
      <thead id="mainHead">
        <tr>
          <th class="sortable" data-sort-key="time">Time</th>
          <th class="sortable" data-sort-key="workflow">Workflow</th>
          <th class="sortable" data-sort-key="eval">Eval</th>
          <th class="sortable" data-sort-key="model">Model</th>
          <th class="sortable" data-sort-key="variant">Variant</th>
          <th class="sortable" data-sort-key="status">Status</th>
          <th class="sortable" data-sort-key="steps">Steps</th>
          <th class="sortable" data-sort-key="elapsed">Elapsed (s)</th>
          <th class="sortable" data-sort-key="tokens">Tokens (in/out/total)</th>
          <th class="sortable" data-sort-key="attempts">Attempts/Step</th>
          <th class="sortable" data-sort-key="reason">Reason</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <details>
      <summary>Raw JSON</summary>
      <pre id="raw" style="white-space: pre-wrap"></pre>
    </details>

    <script>
      const $ = (s) => document.querySelector(s);
      const rows = $("#rows");
      const workflowSel = $("#workflow");
      const variantSel = $("#variant");
      const modelFilter = $("#modelFilter");
      const search = $("#search");
      const reloadBtn = $("#reload");
      const raw = $("#raw");
      const summary = $("#summary");
      const modelRows = document.querySelector("#modelRows");
      const mainHead = document.querySelector("#mainHead");
      const modelHead = document.querySelector("#modelHead");

      let all = [];
      let mainSort = { key: "time", dir: "asc" };
      let modelSort = { key: "model", dir: "asc" };
      // Read initial query params
      const initialParams = new URLSearchParams(location.search);
      const initialWorkflow = initialParams.get("workflow") || "";
      const initialVariant = initialParams.get("variant") || "";
      const initialModel = initialParams.get("model") || "";
      const initialSearch = initialParams.get("search") || "";
      if (initialModel) modelFilter.value = initialModel;
      if (initialSearch) search.value = initialSearch;

      function formatRow(r) {
        const statusClass = r.pass ? "ok" : "fail";
        const attempts = (r.attemptsPerStep || []).join(", ");
        return `<tr>
          <td>${r.timestamp || ""}</td>
          <td>${r.workflowName}</td>
          <td>${r.evalName || ""}</td>
          <td>${r.modelId || ""}</td>
          <td>${r.promptVariant || ""}</td>
          <td><span class="${statusClass}">${
          r.pass ? "PASS" : "FAIL"
        }</span></td>
          <td>${r.steps}</td>
          <td>${(r.elapsedMs / 1000).toFixed(2)}</td>
          <td>${r.tokensIn}/${r.tokensOut}/${r.tokensTotal}</td>
          <td>${attempts}</td>
          <td>${r.reason || ""}</td>
        </tr>`;
      }

      function render(data) {
        const filtered = getFilteredData(data);
        const sorted = sortMainData(filtered, mainSort);
        renderMainTable(sorted);
        renderSummaryCards(filtered);
        renderModelTable(filtered);
      }

      function getFilteredData(data) {
        const wf = workflowSel.value;
        const vv = variantSel.value;
        const mf = modelFilter.value.trim().toLowerCase();
        const q = search.value.trim().toLowerCase();
        let filtered = data;
        if (wf) filtered = filtered.filter((r) => r.workflowName === wf);
        if (vv)
          filtered = filtered.filter((r) => (r.promptVariant || "") === vv);
        if (mf)
          filtered = filtered.filter((r) =>
            (r.modelId || "").toLowerCase().includes(mf)
          );
        if (q)
          filtered = filtered.filter((r) =>
            JSON.stringify(r).toLowerCase().includes(q)
          );
        return filtered;
      }

      function sortMainData(data, sort) {
        const dir = sort.dir === "asc" ? 1 : -1;
        return data.slice().sort((a, b) => {
          const av = getMainSortValue(a, sort.key);
          const bv = getMainSortValue(b, sort.key);
          return compareValues(av, bv) * dir;
        });
      }

      function renderMainTable(data) {
        rows.innerHTML = data.map(formatRow).join("");
        raw.textContent = JSON.stringify(data, null, 2);
        updateMainHeaderIndicators();
      }

      function renderSummaryCards(filtered) {
        const total = filtered.length;
        const pass = filtered.filter((r) => r.pass).length;
        const fail = total - pass;
        const avgSeconds = (
          filtered.reduce((s, r) => s + (r.elapsedMs || 0), 0) /
          (total || 1) /
          1000
        ).toFixed(2);
        const byModel = Object.entries(
          filtered.reduce((m, r) => {
            const k = r.modelId || "unknown";
            m[k] = (m[k] || 0) + 1;
            return m;
          }, {})
        ).sort((a, b) => b[1] - a[1]);

        summary.innerHTML = `
          <div class="card"><div class="muted small">Total</div><div><strong>${total}</strong></div></div>
          <div class="card"><div class="muted small">Pass</div><div><strong>${pass}</strong></div></div>
          <div class="card"><div class="muted small">Fail</div><div><strong>${fail}</strong></div></div>
          <div class="card"><div class="muted small">Avg Elapsed</div><div><strong>${avgSeconds} s</strong></div></div>
          ${byModel
            .map(
              ([m, c]) =>
                `<div class=card><div class="muted small">${m}</div><div><strong>${c}</strong></div></div>`
            )
            .join("")}
        `;
      }

      function updateUrlFromControls() {
        const params = new URLSearchParams(location.search);
        const wf = workflowSel.value;
        const vv = variantSel.value;
        const mf = modelFilter.value.trim();
        const q = search.value.trim();
        if (wf) params.set("workflow", wf);
        else params.delete("workflow");
        if (vv) params.set("variant", vv);
        else params.delete("variant");
        if (mf) params.set("model", mf);
        else params.delete("model");
        if (q) params.set("search", q);
        else params.delete("search");
        const next = `${location.pathname}${
          params.toString() ? `?${params.toString()}` : ""
        }`;
        history.replaceState({}, "", next);
      }

      function renderModelTable(data) {
        if (!modelRows) return;
        const byModel = {};
        for (const r of data) {
          const k = r.modelId || "unknown";
          if (!byModel[k]) {
            byModel[k] = {
              model: k,
              total: 0,
              pass: 0,
              sumMs: 0,
              in: 0,
              out: 0,
              totalTok: 0,
            };
          }
          byModel[k].total += 1;
          byModel[k].pass += r.pass ? 1 : 0;
          byModel[k].sumMs += r.elapsedMs || 0;
          byModel[k].in += r.tokensIn || 0;
          byModel[k].out += r.tokensOut || 0;
          byModel[k].totalTok += r.tokensTotal || 0;
        }
        const arr = Object.values(byModel)
          .map((x) => {
            const passRate = x.total ? Math.round((x.pass / x.total) * 100) : 0;
            const avgSeconds = x.total ? x.sumMs / x.total / 1000 : 0;
            const avgIn = x.total ? x.in / x.total : 0;
            const avgOut = x.total ? x.out / x.total : 0;
            const avgTotal = x.total ? x.totalTok / x.total : 0;
            return { ...x, passRate, avgSeconds, avgIn, avgOut, avgTotal };
          })
          .sort((a, b) => {
            const dir = modelSort.dir === "asc" ? 1 : -1;
            const av = getModelSortValue(a, modelSort.key);
            const bv = getModelSortValue(b, modelSort.key);
            return compareValues(av, bv) * dir;
          });
        const rowsHtml = arr
          .map((x) => {
            const passRate = x.passRate;
            const avgSeconds = x.avgSeconds.toFixed(2);
            const avgIn = Math.round(x.avgIn);
            const avgOut = Math.round(x.avgOut);
            const avgTotal = Math.round(x.avgTotal);
            return `<tr>
            <td>${x.model}</td>
            <td>${x.total}</td>
            <td>${x.pass}</td>
            <td>${passRate}%</td>
            <td>${avgSeconds}</td>
            <td>${avgIn}/${avgOut}/${avgTotal}</td>
          </tr>`;
          })
          .join("");
        modelRows.innerHTML = rowsHtml;
        updateModelHeaderIndicators();
      }

      function compareValues(a, b) {
        const at = typeof a;
        const bt = typeof b;
        if (at === "number" && bt === "number") {
          if (a < b) return -1;
          if (a > b) return 1;
          return 0;
        }
        const as = String(a).toLowerCase();
        const bs = String(b).toLowerCase();
        return as.localeCompare(bs);
      }

      function getMainSortValue(r, key) {
        switch (key) {
          case "time":
            return r.timestamp ? Date.parse(r.timestamp) || 0 : 0;
          case "workflow":
            return r.workflowName || "";
          case "eval":
            return r.evalName || "";
          case "model":
            return r.modelId || "";
          case "variant":
            return r.promptVariant || "";
          case "status":
            return r.pass ? 1 : 0;
          case "steps":
            return r.steps || 0;
          case "elapsed":
            return r.elapsedMs || 0;
          case "tokens":
            return r.tokensTotal || 0;
          case "attempts":
            return Array.isArray(r.attemptsPerStep)
              ? r.attemptsPerStep.reduce((s, n) => s + (Number(n) || 0), 0)
              : 0;
          case "reason":
            return r.reason || "";
          default:
            return 0;
        }
      }

      function getModelSortValue(x, key) {
        switch (key) {
          case "model":
            return x.model || "";
          case "total":
            return x.total || 0;
          case "pass":
            return x.pass || 0;
          case "passRate":
            return x.passRate || 0;
          case "avgSeconds":
            return x.avgSeconds || 0;
          case "avgTotalTokens":
            return x.avgTotal || 0;
          default:
            return 0;
        }
      }

      function updateMainHeaderIndicators() {
        if (!mainHead) return;
        mainHead.querySelectorAll("th").forEach((th) => {
          th.classList.remove("sorted-asc", "sorted-desc");
          const key = th.getAttribute("data-sort-key");
          if (key && key === mainSort.key) {
            th.classList.add(
              mainSort.dir === "asc" ? "sorted-asc" : "sorted-desc"
            );
          }
        });
      }

      function updateModelHeaderIndicators() {
        if (!modelHead) return;
        modelHead.querySelectorAll("th").forEach((th) => {
          th.classList.remove("sorted-asc", "sorted-desc");
          const key = th.getAttribute("data-sort-key");
          if (key && key === modelSort.key) {
            th.classList.add(
              modelSort.dir === "asc" ? "sorted-asc" : "sorted-desc"
            );
          }
        });
      }

      async function loadFromUrls() {
        try {
          const res = await fetch("/api/list");
          if (!res.ok) throw new Error("Failed to list results");
          const data = await res.json();
          const files = Array.isArray(data.files) ? data.files : [];
          if (files.length === 0) return;
          const bases = files.map((f) =>
            (f.file || "").replace(/\.jsonl$/i, "")
          );
          const arrays = await Promise.all(
            bases.map((b) =>
              fetch(`/api/results/${encodeURIComponent(b)}`).then((r) =>
                r.json()
              )
            )
          );
          all = arrays.flat();
          populateWorkflows(all);
          populateVariants(all);
          render(all);
        } catch (e) {
          console.warn("Load from server failed:", e);
        }
      }

      function populateWorkflows(data) {
        const names = Array.from(
          new Set(data.map((r) => r.workflowName))
        ).sort();
        const previous = workflowSel.value;
        workflowSel.innerHTML = [
          '<option value="">All</option>',
          ...names.map((n) => `<option>${n}</option>`),
        ].join("");
        // Prefer preserving the current selection if still available
        if (previous && names.includes(previous)) {
          workflowSel.value = previous;
        } else if (initialWorkflow && names.includes(initialWorkflow)) {
          // Fallback to initial workflow from query params
          workflowSel.value = initialWorkflow;
        }
      }

      function populateVariants(data) {
        const names = Array.from(
          new Set(data.map((r) => r.promptVariant || ""))
        )
          .filter((x) => x)
          .sort();
        const previous = variantSel.value;
        variantSel.innerHTML = [
          '<option value="">All</option>',
          ...names.map((n) => `<option>${n}</option>`),
        ].join("");
        if (previous && names.includes(previous)) {
          variantSel.value = previous;
        } else if (initialVariant && names.includes(initialVariant)) {
          variantSel.value = initialVariant;
        }
      }

      workflowSel.addEventListener("change", () => {
        updateUrlFromControls();
        render(all);
      });
      variantSel.addEventListener("change", () => {
        updateUrlFromControls();
        render(all);
      });
      modelFilter.addEventListener("input", () => {
        updateUrlFromControls();
        render(all);
      });
      search.addEventListener("input", () => {
        updateUrlFromControls();
        render(all);
      });
      reloadBtn.addEventListener("click", () => loadFromUrls());
      if (mainHead) {
        mainHead.addEventListener("click", (e) => {
          const target = e.target;
          if (!(target instanceof HTMLElement)) return;
          const th = target.closest("th");
          if (!th) return;
          const key = th.getAttribute("data-sort-key");
          if (!key) return;
          if (mainSort.key === key) {
            mainSort.dir = mainSort.dir === "asc" ? "desc" : "asc";
          } else {
            mainSort = { key, dir: "asc" };
          }
          render(all);
        });
      }
      if (modelHead) {
        modelHead.addEventListener("click", (e) => {
          const target = e.target;
          if (!(target instanceof HTMLElement)) return;
          const th = target.closest("th");
          if (!th) return;
          const key = th.getAttribute("data-sort-key");
          if (!key) return;
          if (modelSort.key === key) {
            modelSort.dir = modelSort.dir === "asc" ? "desc" : "asc";
          } else {
            modelSort = { key, dir: "asc" };
          }
          // Preserve current filters when sorting the model table
          renderModelTable(getFilteredData(all));
        });
      }

      // Initial: load from server automatically
      populateWorkflows([]);
      loadFromUrls();
    </script>
  </body>
</html>
